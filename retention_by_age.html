<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2113.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Arial; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Times; -webkit-text-stroke: #000000; min-height: 14.0px}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Arial; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
    span.Apple-tab-span {white-space:pre}
  </style>
</head>
<body>
<p class="p1"><span class="s1">with main_data as(</span></p>
<p class="p1"><span class="s1">  select *,CAST(RIGHT(week,length(week)-POSITION(' ' in week)) as int) as week_number </span></p>
<p class="p1"><span class="s1">  from table_1</span></p>
<p class="p1"><span class="s1">)</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">,signup as (</span></p>
<p class="p1"><span class="s1">  select user_id,MIN(week_number) as signup_week</span></p>
<p class="p1"><span class="s1">  from main_data</span></p>
<p class="p1"><span class="s1">  group by 1</span></p>
<p class="p1"><span class="s1">)</span></p>
<p class="p1"><span class="s1">,final_data as (</span></p>
<p class="p1"><span class="s1">  select md.*, s.signup_week, week_number- s.signup_week as retention_week</span></p>
<p class="p1"><span class="s1">  from main_data md</span></p>
<p class="p1"><span class="s1">  left join signup s</span></p>
<p class="p1"><span class="s1">  on s.user_id = md.user_id</span></p>
<p class="p1"><span class="s1">)</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">select age</span></p>
<p class="p1"><span class="s1"><span class="Apple-tab-span">	</span>,count(DISTINCT  case when retention_week =0 then user_id else null end) as total_users</span></p>
<p class="p1"><span class="s1"><span class="Apple-tab-span">	</span>,count(distinct case when retention_week &lt; 10 and retention_week &gt;0 then user_id else null end) as "10_week_retention"</span></p>
<p class="p1"><span class="s1"><span class="Apple-tab-span">	</span>,count(distinct case when retention_week = 20  then user_id else null end) as "20_week_retention"</span></p>
<p class="p3"><span class="s1"><span class="Apple-tab-span">	</span></span></p>
<p class="p1"><span class="s1"><span class="Apple-tab-span">	</span>--,ARRAY_AGG(distinct case when retention_week &lt; 10 then user_id else null end) as users</span></p>
<p class="p1"><span class="s1">from final_data</span></p>
<p class="p1"><span class="s1">GROUP by 1</span></p>
<p class="p2"><span class="s1"></span><br></p>
</body>
</html>
